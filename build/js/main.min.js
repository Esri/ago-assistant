/*! ago-assistant 2.7.2 */

require(["jquery","portal","mustache","nprogress","esri/arcgis/Portal","esri/arcgis/OAuthInfo","esri/IdentityManager","clipboard","highlight","jquery.ui","bootstrap-shim"],function(a,b,c,d,e,f,g,h,i){var j=new f({appId:"1FiblfzwQ8nD2D0C",popup:!0,portalUrl:"https://www.arcgis.com/"}),k={stats:{activities:{}},portals:{arcgisOnline:new b.Portal({portalUrl:"https://www.arcgis.com/"})}},l=function(a){var b,c,d=decodeURIComponent(window.location.search.substring(1)),e=d.split("&");for(c=0;c<e.length;c++)if(b=e[c].split("="),b[0].toLowerCase()===a.toLowerCase())return void 0===b[1]||b[1]},m=localStorage.getItem("storedPortals"),n=function(b){var c;b=b.trim(),m.some(function(a,d){if(a.portalUrl==b)return c=d,!0}),c>=0&&m.splice(c,1),localStorage.setItem("storedPortals",JSON.stringify(m)),a("#portalList").children().each(function(c,d){a(d).first().text().trim()==b&&a(d).remove()}),a("#portalList2").children().each(function(c,d){a(d).first().text().trim()==b&&a(d).remove()}),a("#portalList").children().length||a("#portalListBtn").attr("disabled",!0),a("#portalList2").children().length||a("#portalList2Btn").attr("disabled",!0)},o=function(c){var d=c.portalUrl,e=c.appId,f=c.usePkiIwa,g=c.useOauth,h=c.useUserPass,i=!1;m.some(function(a,b){if(a.portalUrl==d)return a.appId=e,i=!0,!0}),i||m.push({portalUrl:d,appId:e,usePkiIwa:f,useOauth:g,useUserPass:h}),localStorage.setItem("storedPortals",JSON.stringify(m)),a("#portalList").empty(),a("#portalList2").empty(),m.forEach(function(c){a("#portalListBtn").removeAttr("disabled"),a("#portalList2Btn").removeAttr("disabled");var d=a('<a href="#" class="removePortalBtn btn-xs pull-right">   <span class="text-danger glyphicon glyphicon-remove" aria-hidden="true"></span></a>'),e=a('<a href="#" class="removePortalBtn btn-xs pull-right">   <span class="text-danger glyphicon glyphicon-remove" aria-hidden="true"></span></a>'),f=a('<a href="#">'+c.portalUrl+"</a>"),g=a('<a href="#">'+c.portalUrl+"</a>"),h=a("<li></li>"),i=a("<li></li>");h.append(f),h.append(d),i.append(g),i.append(e),a("#portalList").append(h),a("#portalList2").append(i),f.on("click",function(){a("#portalAppId").val(c.appId),a("#portalUrl").val(c.portalUrl),k.portals.sourcePortal||(k.portals.sourcePortal=new b.Portal),p("#portalUrl",k.portals.sourcePortal,"#portalLoginBtn"),c.appId?a("#oauthTabBtn").trigger("click"):(a("#userPassTabBtn").trigger("click"),a("#portalUsername").focus())}),g.on("click",function(){a("#portalAppId2").val(c.appId),a("#destinationUrl").val(c.portalUrl),k.portals.destinationPortal||(k.portals.destinationPortal=new b.Portal),p("#destinationUrl",k.portals.destinationPortal,"#destinationLoginBtn"),c.appId?a("#oauthTab2Btn").trigger("click"):(a("#userPassTab2Btn").trigger("click"),a("#destinationUsername").focus())}),d.on("click",function(){console.log("remove",c.portalUrl),n(c.portalUrl)}),e.on("click",function(){console.log("remove",c.portalUrl),n(c.portalUrl)})})};m=m?JSON.parse(m):[],m.forEach(function(a){o(a)});var p=function(c,d,e){"use strict";var f=a.trim(a(c).val());b.util.fixUrl(f).then(function(b){a(c).val(b);var f=a("#urlErrorTemplate").html(),g=a(c).parent().parent().find("input[type='checkbox']");a(c).parent().removeClass("has-error"),a(c).next().removeClass("glyphicon-ok"),d.portalUrl=b,d.version().then(function(b){console.info("API v"+b.currentVersion),a(".alert-danger.alert-dismissable").remove(),a(c).next().addClass("glyphicon-ok"),a(e).removeAttr("disabled")}).catch(function(){d.withCredentials=!0,d.version().then(function(b){console.info("API v"+b.currentVersion),a(".alert-danger.alert-dismissable").remove(),a(c).next().addClass("glyphicon-ok"),a(e).removeAttr("disabled"),a(g).trigger("click")}).catch(function(){d.jsonp=!0,d.version().then(function(b){d.jsonp=!1,console.info("API v"+b.currentVersion),a(".alert-danger.alert-dismissable").remove(),a(c).next().addClass("glyphicon-ok"),a(e).removeAttr("disabled")}).catch(function(){d.withCredentials=!1,d.jsonp=!1,a(".alert-danger.alert-dismissable").remove(),a(c).parent().parent().after(f),a(c).parent().addClass("has-error"),a(e).attr("disabled",!0)})})})})},q=function(){"use strict";var b;k.portals.sourcePortal.self().then(function(e){var f=a("#sessionTemplate").html(),g=c.to_html(f,e);k.portals.sourcePortal.username=e.user.username,!0===e.isPortal?k.portals.sourcePortal.portalUrl="https://"+e.portalHostname+"/":!1===e.isPortal&&e.id?k.portals.sourcePortal.portalUrl="https://"+e.urlKey+"."+e.customBaseUrl+"/":k.portals.sourcePortal.portalUrl="https://www.arcgis.com/",a(".nav.navbar-nav").after(g),a("#logout").show(),a("#actionDropdown").css({visibility:"visible"}),b=c.to_html(a("#searchTemplate").html(),{portal:k.portals.sourcePortal.portalUrl,name:e.name,id:e.id}),a("#actionDropdown").before(b),a(document).on("click","i.glyphicon-search",function(){w()}),a("#searchForm").keypress(function(a){13==a.which&&w()}),d.start(),N(),d.done()})},r=function(){if(a("#oauthTab").hasClass("active"))return void s();a("#pkiIwaTab").hasClass("active")?k.portals.sourcePortal.withCredentials=!0:k.portals.sourcePortal.withCredentials=!1;var b=function(){var a={portalUrl:k.portals.sourcePortal.portalUrl,appId:"",usePkiIwa:k.portals.sourcePortal.withCredentials,useOauth:!1,useUserPass:!k.portals.sourcePortal.withCredentials};o(a)},c=a("#portalUsername").val(),d=a("#portalPassword").val();a("#portalLoginBtn").button("loading"),k.portals.sourcePortal.generateToken(c,d).then(function(c){if(c.token)k.portals.sourcePortal.token=c.token,a("#portalLoginModal").modal("hide"),a("#splashContainer").css("display","none"),a("#itemsContainer").css("display","block"),q(),b();else if(400===c.error.code){var d=a("#loginErrorTemplate").html();a(".alert-danger.alert-dismissable").remove(),a("#portalLoginForm").before(d)}a("#portalLoginBtn").button("reset")}).catch(function(){a("#portalLoginBtn").button("reset");var b=a("#loginErrorTemplate").html();a(".alert-danger.alert-dismissable").remove(),a("#portalLoginForm").before(b)})},s=function(){var c=new f({appId:a("#portalAppId").val(),popup:!0,portalUrl:k.portals.sourcePortal.portalUrl}),d=function(){var a={portalUrl:c.portalUrl,appId:c.appId,usePkiIwa:!1,useOauth:!0,useUserPass:!1};o(a)};g.registerOAuthInfos([c]),b.util.fixUrl(c.portalUrl).then(function(b){var c=b;-1===c.indexOf("arcgis.com")&&(c+="sharing/"),g.checkSignInStatus(c).then(function(b){a("#portalLoginModal").modal("hide"),a("#splashContainer").css("display","none"),a("#itemsContainer").css("display","block"),k.portals.sourcePortal.username=b.userId,k.portals.sourcePortal.token=b.token,q(),d()}).otherwise(function(){g.getCredential(b,{oAuthPopupConfirmation:!1}).then(function(b){a("#portalLoginModal").modal("hide"),a("#splashContainer").css("display","none"),a("#itemsContainer").css("display","block"),k.portals.sourcePortal.username=b.userId,k.portals.sourcePortal.token=b.token,q(),d()})})})},t=function(){if(a("#oauthTab2").hasClass("active"))return void u();var c=a("#destinationUsername").val(),e=a("#destinationPassword").val(),f=a("#destinationUrl").val();k.portals.destinationPortal||(k.portals.destinationPortal=new b.Portal({portalUrl:f})),a("#pkiIwaTab2").hasClass("active")?k.portals.destinationPortal.withCredentials=!0:k.portals.destinationPortal.withCredentials=!1;var g=function(){var a={portalUrl:k.portals.destinationPortal.portalUrl,appId:"",usePkiIwa:k.portals.destinationPortal.withCredentials,useOauth:!1,useUserPass:!k.portals.destinationPortal.withCredentials};o(a)};a("#destinationLoginBtn").button("loading"),a("#dropArea").empty(),k.portals.destinationPortal.generateToken(c,e).then(function(b){if(b.token)k.portals.destinationPortal.token=b.token,k.portals.destinationPortal.self().then(function(b){k.portals.destinationPortal.username=b.user.username,!0===b.isPortal?k.portals.destinationPortal.portalUrl="https://"+b.portalHostname+"/":!1===b.isPortal&&b.id?k.portals.destinationPortal.portalUrl="https://"+b.urlKey+"."+b.customBaseUrl+"/":k.portals.destinationPortal.portalUrl="https://"+b.portalHostname+"/",a("#copyModal").modal("hide"),I(),d.start(),P(),d.done(),g()});else if(400===b.error.code){var c=a("#loginErrorTemplate").html();a(".alert-danger.alert-dismissable").remove(),a("#destinationLoginForm").before(c)}}).catch(function(){var b=a("#loginErrorTemplate").html();a(".alert-danger.alert-dismissable").remove(),a("#destinationLoginForm").before(b)}).then(function(){a("#destinationLoginBtn").button("reset")})},u=function(){var c=new f({appId:a("#portalAppId2").val(),popup:!0,portalUrl:k.portals.destinationPortal.portalUrl});g.registerOAuthInfos([c]);var e=function(){var a={portalUrl:c.portalUrl,appId:c.appId,usePkiIwa:!1,useOauth:!0,useUserPass:!1};o(a)},h=g.toJson(),i=sessionStorage.esriJSAPIOAuth;sessionStorage.setItem("esriJSAPIOAuthBackup",i),sessionStorage.setItem("esriIdBackup",JSON.stringify(h)),g.destroyCredentials(),sessionStorage.removeItem("esriJSAPIOAuth"),b.util.fixUrl(c.portalUrl).then(function(f){var j=f;-1===j.indexOf("arcgis.com")&&(j+="sharing/"),g.checkSignInStatus(j).then(function(f){k.portals.destinationPortal&&k.portals.destinationPortal.portalUrl===c.portalUrl?(k.portals.destinationPortal.username=f.userId,k.portals.destinationPortal.token=f.token):k.portals.destinationPortal=new b.Portal({portalUrl:c.portalUrl,username:f.userId,token:f.token}),g.initialize(h),sessionStorage.setItem("esriJSAPIOAuth",i),k.portals.destinationPortal.self().then(function(){a("#copyModal").modal("hide"),I(),d.start(),P(),d.done(),e()})}).otherwise(function(){g.getCredential(f,{oAuthPopupConfirmation:!1}).then(function(f){k.portals.destinationPortal&&k.portals.destinationPortal.portalUrl===c.portalUrl?(k.portals.destinationPortal.username=f.userId,k.portals.destinationPortal.token=f.token):k.portals.destinationPortal=new b.Portal({portalUrl:c.portalUrl,username:f.userId,token:f.token}),g.initialize(h),sessionStorage.setItem("esriJSAPIOAuth",i),k.portals.destinationPortal.self().then(function(){a("#copyModal").modal("hide"),I(),d.start(),P(),d.done(),e()})})})})},v=function(){sessionStorage.clear(),k.stats.activities={},a("#actionDropdown li").removeClass("active"),a("#itemsArea").empty(),a("#dropArea").empty(),a("#sessionDropdown").remove(),a("#searchForm").remove(),a("#actionDropdown").css({visibility:"hidden"}),g.destroyCredentials(),delete k.portals.sourcePortal,delete k.portals.destinationPortal,window.location.reload()},w=function(){var b,c=a("#searchText").val(),e=a("#searchMenu li.active").attr("data-url");a("#searchMenu li.active").attr("data-id")&&(c+=" accountid:"+a("#searchMenu li.active").attr("data-id")),"Search My Content"===a("#searchMenu li.active").text()&&(c+=" owner:"+k.portals.sourcePortal.username),b="https://www.arcgis.com/"===e&&e!==k.portals.sourcePortal.portalUrl?k.portals.arcgisOnline:k.portals.sourcePortal,d.start(),b.search(c,100,"numViews","desc").then(function(a){M(b.portalUrl,a),d.done()})},x=function(){var b,e,f;new h(".btn").on("success",function(b){var c=a(b.trigger);c.tooltip({title:"Copied!",placement:"left",container:"body"}),c.tooltip("show"),c.mouseleave(function(){c.tooltip("destroy")}),b.clearSelection()});var g=function(a){try{var b=JSON.parse(a);if(b&&"object"==typeof b&&null!==b)return b}catch(a){}return!1},j=function(c){c.stopImmediatePropagation();var d=a(c.currentTarget).parent().next(),h=a(c.currentTarget),j=a(c.currentTarget).parent().children("[data-action='saveEdits']");if(j.children("span").attr("class","fa fa-lg fa-save"),"true"!==d.attr("contentEditable")){h.children("span").attr("class","fa fa-lg fa-undo"),h.attr("data-toggle","tooltip"),h.attr("data-placement","bottom"),h.attr("title","Discard your edits"),h.tooltip(),e=d.text(),d.attr("contentEditable","true");var k=/Trident/.test(navigator.userAgent)?"paste cut keyup":"input";d.bind(k,function(){f=g(d.text()),j.tooltip("destroy"),f?(j.removeClass("disabled"),j.css("color","green"),j.attr("data-toggle","tooltip"),j.attr("data-placement","bottom"),j.attr("title","JSON is valid. Click to save.")):(j.css("color","red"),j.attr("data-toggle","tooltip"),j.attr("data-placement","bottom"),j.attr("title","JSON is invalid. Saving not allowed.")),j.tooltip({container:"body"})}),h.attr("class","btn btn-default"),j.attr("class","btn btn-default")}else d.attr("contentEditable","false"),d.text(e),d.each(function(a,b){i.highlightBlock(b)}),h.attr("class","btn btn-default"),h.children("span").attr("class","fa fa-lg fa-pencil"),h.tooltip("destroy"),j.attr("class","btn btn-default disabled"),j.css("color","black");j.click(function(){if(f){var c=d.text(),e=JSON.parse(a("#descriptionJson").text());h.attr("class","btn btn-default"),h.children("span").attr("class","fa fa-lg fa-pencil"),j.attr("class","btn btn-default disabled"),j.css("color","black"),d.attr("contentEditable","false"),j.children("span").attr("class","fa fa-lg fa-spinner fa-spin");var g;g=e.ownerFolder?e.ownerFolder:"/","Description"===h.attr("data-container")?b.updateDescription(e.owner,e.id,g,c).then(function(a){a.success?(j.children("span").attr("class","fa fa-lg fa-check"),j.css("color","green")):(j.children("span").attr("class","fa fa-lg fa-times"),j.css("color","red"))}):"Data"===h.attr("data-container")&&(j.children("span").attr("class","fa fa-lg fa-spinner fa-spin"),b.updateData(e.owner,e.id,g,c).then(function(a){a.success?(j.children("span").attr("class","fa fa-lg fa-check"),j.css("color","green")):(j.children("span").attr("class","fa fa-lg fa-times"),j.css("color","red"))}))}else j.removeClass("active")})};a(".content").addClass("data-toggle"),a(".content").removeAttr("disabled"),a(".content").attr("data-toggle","button"),a(".content").addClass("btn-info"),a("#inspectModal").modal("hide"),a("#inspectBtn").button("reset"),a(".content").click(function(){var e,f=a(this).attr("data-portal"),g=a(this).attr("data-id"),h=a(this).text();b="https://www.arcgis.com/"===f&&f!==k.portals.sourcePortal.portalUrl?k.portals.arcgisOnline:k.portals.sourcePortal,d.start(),a(".content").addClass("btn-info"),a(".content").removeClass("active"),a(".content").removeClass("btn-primary"),a(this).addClass("btn-primary"),a(this).removeClass("btn-info"),b.itemDescription(g).then(function(f){b.itemData(g).then(function(k){k&&(e=k);var l={title:h,url:b.portalUrl,id:g,description:JSON.stringify(f,void 0,2),data:JSON.stringify(e,void 0,2)};void 0===l.data&&-1===f.typeKeywords.indexOf("Service")&&(l.downloadLink=b.portalUrl+"sharing/rest/content/items/"+g+"/data?token="+b.token);var m=c.to_html(a("#inspectTemplate").html(),l);a("#dropArea").html(m),a("pre").each(function(a,b){i.highlightBlock(b)}),a(".btn-default[data-action='startEdits']").click(function(b){if(localStorage.hasOwnProperty("editsAllowed"))j(b);else{var c=a("#editJsonBtn");a("#editJsonModal").modal("show"),a(".acknowledgeRisk").click(function(b){a(b.currentTarget).prop("checked")?c.removeClass("disabled"):c.addClass("disabled")})}a("#editJsonBtn").click(function(){a("#editJsonModal").modal("hide"),localStorage.setItem("editsAllowed",!0),j(b)})}),d.done()})})})},y=function(){var b,d,e,f=a.merge(a(".content[data-type='Web Map']"),a(".content[data-type='Web Scene']")),g=k.portals.sourcePortal;f.addClass("data-toggle btn-info"),f.removeAttr("disabled"),f.attr("data-toggle","button"),a(".content").click(function(){var f=a(this).attr("data-id"),h=a(this).text();a(".content[data-type='Web Map']").addClass("btn-info"),a(".content").removeClass("active"),a(".content").removeClass("btn-primary"),a(this).addClass("btn-primary"),a(this).removeClass("btn-info"),g.itemDescription(f).then(function(a){d=a.owner,e=a.ownerFolder?a.ownerFolder:""}),g.itemData(f).then(function(f){function i(a){var b=a.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);return b[1]+"//"+b[2]}b=JSON.stringify(f);var j=[];a.each(f.operationalLayers,function(){this.hasOwnProperty("url")?j.push(this):this.hasOwnProperty("styleUrl")&&(this.url=this.styleUrl,j.push(this))});var k=[];f.tables&&a.each(f.tables,function(a){f.tables[a].hasOwnProperty("url")&&k.push(f.tables[a])});var l=f.baseMap.title,m=[];a.each(f.baseMap.baseMapLayers,function(){this.hasOwnProperty("url")?m.push(this):this.hasOwnProperty("styleUrl")&&(this.url=this.styleUrl,m.push(this))});var n=a("#webmapServicesTemplate").html(),o={webmapTitle:h,operationalLayers:j,tables:k,basemapTitle:l,basemapLayers:m},p=c.to_html(n,o);a("#dropArea").html(p);var q=a("[data-original]"),r=[];a("#origServiceUrlList").empty(),a.each(q,function(b){var c=a(q[b]).val(),d=i(c);-1===a.inArray(d,r)&&(r.push(d),a("#origServiceUrlList").append("<option value="+d+">"+d+"</option>"))}),a("#originalTextUserInput").bind("input",function(){var b=a("#originalTextUserInput").val(),c=0;if(b.length>0){var d=a("[data-original]");a.each(d,function(e){a(d[e]).val().indexOf(b)>-1&&(c+=1)})}var e=1===c?"match":"matches";a("#stringMatchesFoundText").text("Found "+c.toString()+" text "+e+" in this web map's service URLs (case sensitive).")}),a("#bulkUpdateWebmapServiceUrlsBtn").click(function(b){b.preventDefault();var c=a("#originalTextUserInput").val(),d=a("#newTextUserInput").val();if(c.length>0){var e=a("[data-original]"),f=0;a.each(e,function(b){var g=a(e[b]).val();if(g.indexOf(c)>-1){var h=g.replace(c,d);a(e[b]).val(h),f+=1}})}a("#originalTextUserInput").val(""),a("#newTextUserInput").val(""),a("#stringMatchesFoundText").text("")}),a("#btnUpdateWebmapServices").click(function(){var f=a("[data-original]");a.each(f,function(c){var d=a(f[c]).attr("data-original"),e=a(f[c]).val();b=b.replace('"'+d+'"','"'+e+'"'),a(f[c]).val(e)});var h=a(".content.active.btn-primary").attr("data-id"),i=JSON.parse(b);g.updateWebmapData(d,e,h,i).then(function(b){var d;b.success?(a.each(f,function(b){a(f[b]).attr("data-original",a(f[b]).val())}),d=c.to_html(a("#updateSuccessTemplate").html()),a("#btnResetWebmapServices").before(d)):400!==b.error.code&&403!==b.error.code||(a("#btnResetWebmapServices").click(),d=c.to_html(a("#updateErrorTemplate").html(),b),a("#btnResetWebmapServices").before(d))})}),a("#btnResetWebmapServices").click(function(){var b=a("[data-original]");a.each(b,function(c){var d=a(b[c]).attr("data-original");a(b[c]).val(d)})})})})},z=function(){var b,d,e=a(".content[data-type='Feature Service'], .content[data-type='Map Service'], .content[data-type='Image Service'], .content[data-type='KML'], .content[data-type='WMS'], .content[data-type='Geodata Service'], .content[data-type='Globe Service'], .content[data-type='Geometry Service'], .content[data-type='Geocoding Service'], .content[data-type='Network Analysis Service'], .content[data-type='Geoprocessing Service'], .content[data-type='Web Mapping Application'], .content[data-type='Mobile Application'], .content[data-type='Scene Service'], .content[data-type='Vector Tile Service']"),f=k.portals.sourcePortal;e.addClass("data-toggle btn-info"),e.removeAttr("disabled"),e.attr("data-toggle","button"),a(".content").click(function(){var g=a(this).attr("data-id");e.addClass("btn-info"),a(".content").removeClass("active"),a(".content").removeClass("btn-primary"),a(this).addClass("btn-primary"),a(this).removeClass("btn-info"),f.itemDescription(g).then(function(e){b=e.owner,d=e.ownerFolder?e.ownerFolder:"";var g=c.to_html(a("#itemContentTemplate").html(),e);a("#dropArea").html(g),a("#btnUpdateContentUrl").click(function(){var e=a(".content.active.btn-primary").attr("data-id"),g=a("[data-original]").val();f.updateUrl(b,d,e,g).then(function(b){var d;b.success?(a("[data-original]").attr("data-original",g),d=c.to_html(a("#updateSuccessTemplate").html()),a("#btnResetContentUrl").before(d)):400!==b.error.code&&403!==b.error.code||(a("#btnResetContentUrl").click(),d=c.to_html(a("#updateErrorTemplate").html(),b),a("#btnResetContentUrl").before(d))})}),a("#btnResetContentUrl").click(function(){var b=a("[data-original]").attr("data-original");a("[data-original]").val(b)})})})},A=function(){var b=k.portals.sourcePortal;b.userProfile(b.username).then(function(d){var e,f=a("#statsTemplate").html();e=d.thumbnail?b.portalUrl+"sharing/rest/community/users/"+d.username+"/info/"+d.thumbnail+"?token="+b.token:"assets/images/no-user-thumb.jpg";var g={username:d.username,thumbnail:e},h=c.to_html(f,g);a("body").append(h),a("#statsModal").modal("show");var i="owner:"+b.username;b.search(i,3,"numViews","desc").then(function(d){a.each(d.results,function(a){d.results[a].numViews=d.results[a].numViews.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),d.results[a].itemUrl=b.portalUrl+"home/item.html?id="+d.results[a].id});var e=a("#mostViewedContentTemplate").html();a("#mostViewedContent").html(c.to_html(e,{searchResults:d.results}))}),a("#statsModal").on("hidden.bs.modal",function(){a("#statsModal").remove()})})},B=function(b){var d=new a.Deferred,e=a("#serviceName");return a("#serviceName").off("blur"),e.blur(function(){var f=e.val();b.self().then(function(g){b.checkServiceName(g.user.orgId,f,"Feature Service").then(function(b){if(!0!==b.available){var g=c.to_html(a("#serviceNameErrorTemplate").html(),{name:f});a(".alert-danger.alert-dismissable").remove(),e.parent().parent().after(g),e.parent().addClass("has-error"),e.next().removeClass("glyphicon-ok")}else f=e.val(),a(".alert-danger.alert-dismissable").remove(),e.parent().removeClass("has-error"),e.next().addClass("glyphicon-ok"),a("#btnCopyService").removeClass("disabled"),d.resolve(f)})})}),d.promise()},C=function(b,d){var e=c.to_html(a("#contentCopyErrorTemplate").html(),{id:b,message:d});a("#"+b+"_clone").before(e)},D=function(b,d){var e,f=a("#"+b).attr("data-portal");e="https://www.arcgis.com/"===f&&f!==k.portals.sourcePortal.portalUrl?k.portals.arcgisOnline:k.portals.sourcePortal;var g=k.portals.destinationPortal,h=a.grep(e.items,function(a){return a.id===b}),i=h[0].description,j=e.portalUrl+"sharing/rest/content/items/"+b+"/info/"+i.thumbnail+"?token="+e.token;e.itemData(b).then(function(e){g.addItem(g.username,d,i,e,j).then(function(d){var e;if(!0===d.success)if(i.url.indexOf("id=")>-1){var f=g.portalUrl+i.url.substring(i.url.indexOf("apps/"));f=f.replace("id="+i.id,"id="+d.id);var h=d.folder||"";g.updateUrl(g.username,h,d.id,f).then(function(){a("#"+b+"_clone").addClass("btn-success")})}else a("#"+b+"_clone").addClass("btn-success");else d.error&&(a("#"+b+"_clone").addClass("btn-danger"),e=c.to_html(a("#contentCopyErrorTemplate").html(),{id:b,message:d.error.message}),a("#"+b+"_clone").before(e))}).catch(function(){C(b,"Something went wrong.")})})},E=function(c,d){var e,f=a("#"+c).attr("data-portal");e="https://www.arcgis.com/"===f&&f!==k.portals.sourcePortal.portalUrl?k.portals.arcgisOnline:k.portals.sourcePortal;var g=k.portals.destinationPortal,h=a("#serviceName").val(),i=a.grep(e.items,function(a){return a.id===c}),j=i[0].description,l=i[0].serviceDescription,m=l.layers,n=a("#"+c+"_clone"),o=a("#"+c+"_clone > span");n.text(h),n.prepend(o),n.addClass("btn-info"),n.append("<div class='message'><p class='messages'></p></div>");var p=a("#"+c+"_clone").find(".messages");l.name=h;var q=l;delete q.layers,p.text("creating service"),p.after("<img src='css/grid.svg' class='harvester'/>"),g.createService(g.username,d,JSON.stringify(q)).then(function(c){n.attr("data-id",c.itemId),n.attr("data-portal",g.portalUrl),c.serviceurl=b.util.upgradeUrl(c.serviceurl);var f=j.tags;f.push("sourceId-"+j.id),f.push("copied with ago-assistant"),g.updateDescription(g.username,c.itemId,d,JSON.stringify({tags:f})),e.serviceLayers(j.url).then(function(b){var d=b.layers.length,f={},i={},k=function(a){if(f[a].attempted>=f[a].recordCount&&(i[a]=f[a],delete f[a]),0===Object.keys(f).length){var b=!1;console.info("Copy summary for "+h),Object.keys(i).forEach(function(a){var c=i[a];c.added!==c.recordCount?(b=!0,console.warn(a+" ("+c.name+"): Added "+c.added.toLocaleString([])+"/"+c.recordCount.toLocaleString([])+" records")):console.info(a+" ("+c.name+"): Added "+c.added.toLocaleString([])+"/"+c.recordCount.toLocaleString([])+" records")}),n.find("img").remove(),n.removeClass("btn-info"),b?(n.addClass("btn-warning"),p.text("Incomplete--check console")):(n.addClass("btn-success"),p.text("Copy OK"))}};a.each(b.layers,function(a,b){f[b.id]={name:b.name,recordCount:0,attempted:0,added:0},b.adminLayerInfo={geometryField:{name:"Shape",srid:102100}},b.indexes=[]}),p.text("updating definition"),g.addToServiceDefinition(c.serviceurl,JSON.stringify(b)).then(function(i){"error"in i?(n.find("img").remove(),n.removeClass("btn-info"),n.addClass("btn-danger"),p.text("Failed—check console"),console.info("Copy summary for "+h),console.warn(i.error.message),i.error.details.forEach(function(a){console.warn(a)})):a.each(m,function(a,i){var l=i.id;e.layerRecordCount(j.url,l).then(function(a){var i=0;f[l].recordCount=a.count;for(var m=b.layers[l].maxRecordCount<1?1e3:b.layers[l].maxRecordCount,n=1;i<=a.count;)n++,p.text("harvesting data"),e.harvestRecords(j.url,l,i,m).then(function(a){p.text("adding features for "+d+" layers"),g.addFeatures(c.serviceurl,l,JSON.stringify(a.features)).then(function(b){f[l].attempted+=a.features.length,f[l].added+=b.addResults.length,k(l)}).catch(function(){f[l].attempted+=a.features.length,k(l)})}).catch(function(){p.text("Incomplete—check console"),console.info("Errors creating service "+h),console.info("Failed to retrieve all records.")}),i+=m})})}).catch(function(){n.find("img").remove(),n.removeClass("btn-info"),n.addClass("btn-danger"),p.text("Failed—check console"),console.info("Errors creating service "+h),console.warn("Failed to create the service.")})})})},F=function(d){var e,f=k.portals.destinationPortal,g=function(d,g){var h=a("#"+d).attr("data-type"),i=a("#"+d).attr("data-portal");if(e="https://www.arcgis.com/"===i&&i!==k.portals.sourcePortal.portalUrl?k.portals.arcgisOnline:k.portals.sourcePortal,K(h))e.itemDescription(d).then(function(c){switch(e.cacheItem(c),h){case"Feature Service":c.url=b.util.upgradeUrl(c.url),e.items[e.items.length-1].description.url=c.url,e.serviceDescription(c.url).then(function(b){var g=a.grep(e.items,function(a){return a.id===d}),h=c.name;null===h&&(h=c.title),a("#serviceName").val(h),g[0].serviceDescription=b,a("#btnCancelCopy").attr("data-id",c.id),a("#btnCopyService").attr("data-id",c.id),a("#deepCopyModal").modal("show"),a("#btnCopyService").removeClass("disabled"),B(f)});break;default:D(d,g)}});else{a("#"+d).addClass("btn-warning");var j=c.to_html(a("#contentTypeErrorTemplate").html(),{id:d,type:h});a("#"+d).before(j),a("#"+d+"_alert").fadeOut(6e3)}},h=function(b,c){"use strict";var d=a(b).attr("data-id"),e=a(b).clone();e.attr("id",d+"_clone"),e.addClass("clone"),e.css("max-width",""),e.insertAfter(c.children(".dropArea")),e.removeClass("active btn-primary btn-info");var f=e.parent().attr("data-folder");g(d,f)};a("#dropFolder_"+d).droppable({accept:".content",activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(b,c){h(c.draggable,a(this).parent().parent())}})},G=function(){a("#dropArea").empty(),a(".content").unbind("click"),a(".content").removeClass("active btn-primary btn-info ui-draggable"),a(".content").attr("disabled","disabled")},H=function(){a("#itemsArea").empty()},I=function(){var b=function(b){var c=a("#itemsArea .in").width()?a("#itemsArea .in").width():400;a(b).css("max-width",c)};a("#itemsArea .content").each(function(){var c=a(this).attr("data-type");K(c)&&(a(this).addClass("btn-info"),b(this),function(a){a.draggable({cancel:!1,helper:"clone",appendTo:"body",revert:!0,opacity:.7}),a.removeAttr("disabled")}(a(this)))})},J=function(){switch(a("#actionDropdown li.active").attr("data-action")){case"copyContent":I();break;case"updateWebmapServices":G(),y();break;case"updateContentUrl":G(),z();break;case"inspectContent":G(),x()}},K=function(b){var c=["Web Map","Web Scene","Map Service","Image Service","Scene Service","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service","Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service","Web Mapping Application","Mobile Application","Operation View","Symbol Set","Color Set","Document Link","Feature Service","Vector Tile Service"];if(a.inArray(b,c)>-1)return!0},L=function(a,b){a.sort(function(a,c){var d=null,e=null;return a[b]&&(d=a[b].toUpperCase()),c[b]&&(e=c[b].toUpperCase()),d<e?-1:d>e?1:0})},M=function(d,e){"use strict";H();var f={title:"Search Results ("+e.query+")",id:"search",count:e.total},g=c.to_html(a("#folderTemplate").html(),f);a("#itemsArea").append(g),a.each(e.results,function(){var e={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:d,user:this.owner};window.xxx=this;var f=c.to_html(a("#contentTemplate").html(),e);a("#collapse_search").append(f).addClass("in")}),J()},N=function(){"use strict";function d(a){var b=a/1e3;k.stats.activities[b]=1}var e=k.portals.sourcePortal;G(),H();var f=a("<h4></h4>"),g=a("<h6></h6>");a("#itemsArea").append(f),a("#itemsArea").append(g),k.portals.sourcePortal.self().then(function(a){var b=a.user,c=(b.email,b.fullName),d=b.username,e=a.name||a.portalName;f.text(e),g.text(c+" ("+d+")")}),e.userContent(e.username,"/").then(function(f){var g={title:"Root",id:"",count:f.items.length},h=c.to_html(a("#folderTemplate").html(),g);a("#itemsArea").append(h),L(f.items,"title"),a.each(f.items,function(g){var h={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:e.portalUrl},i=c.to_html(a("#contentTemplate").html(),h);a("#collapse_").append(i),d(f.items[g].modified)}),L(f.folders,"title"),a.each(f.folders,function(){var f={title:this.title,id:this.id,count:0},g=c.to_html(a("#folderTemplate").html(),f);a("#itemsArea").append(g),e.userContent(e.username,this.id).then(function(f){a("#collapse_"+f.currentFolder.id).parent().find("span.badge")[0].innerHTML=f.total,L(f.items,"title"),a.each(f.items,function(g){var h={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:e.portalUrl},i=c.to_html(a("#contentTemplate").html(),h);a("#collapse_"+this.ownerFolder).append(i),d(f.items[g].modified)})})}),setTimeout(function(){J()},1e3)})},O=function(){"use strict";var d=k.portals.sourcePortal;G(),H(),d.userProfile(d.username).then(function(e){L(e.groups,"title"),a.each(e.groups,function(){var e=this,f="group:"+this.id,g={title:this.title,id:this.id,count:0},h=c.to_html(a("#folderTemplate").html(),g);a("#itemsArea").append(h),d.search(f,100,"title","asc").then(function(f){a("#collapse_"+e.id).parent().find("span.badge")[0].innerHTML=f.total,a.each(f.results,function(){var f={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:d.portalUrl},g=c.to_html(a("#contentTemplate").html(),f);a("#collapse_"+e.id).append(g)})})}),setTimeout(function(){J()},1e3)})},P=function(){"use strict";var d=k.portals.destinationPortal,e=a("<h4></h4>"),f=a("<h6></h6>");a("#dropArea").append(e),a("#dropArea").append(f),k.portals.destinationPortal.self().then(function(a){var b=a.user,c=(b.email,b.fullName),d=b.username,g=a.name||a.portalName;e.text(g),f.text(c+" ("+d+")")}),d.userContent(d.username,"/").then(function(e){var f,g;f={title:"Root",id:"",count:e.items.length},g=c.to_html(a("#dropFolderTemplate").html(),f),a("#dropArea").append(g),L(e.items,"title"),a.each(e.items,function(){var e={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:d.portalUrl},f=c.to_html(a("#contentTemplate").html(),e);a("#collapseDest_").append(f)}),F(""),L(e.folders,"title"),a.each(e.folders,function(){f={title:this.title,id:this.id,count:0},g=c.to_html(a("#dropFolderTemplate").html(),f),a("#dropArea").append(g),d.userContent(d.username,this.id).then(function(e){L(e.items,"title"),a.each(e.items,function(){var f={id:this.id,title:this.title,type:this.type,icon:b.itemInfo(this.type).icon,portal:d.portalUrl},g=c.to_html(a("#contentTemplate").html(),f);a("#collapseDest_"+e.currentFolder.id).append(g)}),a("#collapseDest_"+e.currentFolder.id).collapse("hide"),F(e.currentFolder.id)})})})};a(document).ready(function(){a(".loginButtons > p > button").removeAttr("disabled"),
sessionStorage.esriJSAPIOAuthBackup&&sessionStorage.esriIdBackup&&(g.destroyCredentials(),g.initialize(JSON.parse(sessionStorage.getItem("esriIdBackup"))),sessionStorage.setItem("esriJSAPIOAuth",sessionStorage.getItem("esriJSAPIOAuthBackup"))),g.registerOAuthInfos([j]),b.util.fixUrl(j.portalUrl).then(function(c){var d=c;-1===d.indexOf("arcgis.com")&&(d+="sharing/"),g.checkSignInStatus(d).then(function(d){a("#splashContainer").css("display","none"),a("#itemsContainer").css("display","block"),k.portals.sourcePortal=new b.Portal({portalUrl:c,username:d.userId,token:d.token}),q()}).otherwise(function(){a("#itemsContainer").css("display","none"),a("#splashContainer").css("display","block");var c=l("portal"),d=l("appid");c&&(k.portals.sourcePortal=new b.Portal({portalUrl:c}),a("#portalUrl").val(c),p("#portalUrl",k.portals.sourcePortal,"#portalLoginBtn"),a("[data-action='login-portal']").trigger("click"),d&&(a("#portalAppId").val(d),a("#oauthTabBtn").trigger("click")))})});var c=function(){"use strict";a(".itemArea").height(a(window).height()-50)};c();!function(){"use strict";a("html").bind("keypress",function(b){if(13===b.keyCode&&"true"!==a(b.target).attr("contenteditable"))return!1})}(),a("#destinationUrl").css({display:"none"}),a("#destinationWebTierAuth").css({display:"none"}),a("#destinationLoginForm").css({display:"none"}),a("#destinationAgolBtn").click(function(){a(".alert-danger.alert-dismissable").remove(),a("#destinationUrl").next().removeClass("glyphicon-ok"),a("#destinationUrl").parent().removeClass("has-error"),a("#destinationUrl").attr({placeholder:"",value:"https://www.arcgis.com/"}),a("#destinationUrl").val("https://www.arcgis.com/"),a("#portalDestinationGroup").css({display:"none"}),a("#destinationUrl").css({display:"none"}),a("#destinationWebTierAuth").css({display:"none"}),a("#destinationLoginForm").css({display:"none"}),a("#destinationLoginBtn").css({display:"none"}),a("#destinationEnterpriseBtn").css({display:"inline"}),a("#destinationAgolBtn").addClass("btn-primary active"),a("#destinationPortalBtn").removeClass("btn-primary active"),k.portals.destinationPortal&&(k.portals.destinationPortal.portalUrl="https://www.arcgis.com/")}),a("#destinationPortalBtn").click(function(){a("#destinationUrl").attr({placeholder:"https://myportal.com/",value:""}),a("#destinationUrl").val(""),a("#portalDestinationGroup").css({display:"block"}),a("#destinationUrl").css({display:"block"}),a("#destinationWebTierAuth").css({display:"block"}),a("#destinationLoginForm").css({display:"block"}),a("#destinationLoginBtn").css({display:"inline"}),a("#destinationEnterpriseBtn").css({display:"none"}),a("#destinationPortalBtn").addClass("btn-primary active"),a("#destinationAgolBtn").removeClass("btn-primary active")}),a(window).resize(function(){c()}),a("#portalUrl").blur(function(){k.portals.sourcePortal||(k.portals.sourcePortal=new b.Portal),setTimeout(function(){p("#portalUrl",k.portals.sourcePortal,"#portalLoginBtn")},500)}),a("#destinationUrl").blur(function(){k.portals.destinationPortal||(k.portals.destinationPortal=new b.Portal),setTimeout(function(){a("#destinationPortalBtn").hasClass("active")&&p("#destinationUrl",k.portals.destinationPortal,"#destinationLoginBtn")},500)}),a("#sourceWebTierAuth").click(function(b){!0===a(b.currentTarget).prop("checked")?(a("#portalUsername").attr("disabled",!0),a("#portalPassword").attr("disabled",!0),a("#portalLoginBtn").text("Proceed"),k.portals.sourcePortal.withCredentials=!0):(a("#portalUsername").removeAttr("disabled"),a("#portalPassword").removeAttr("disabled"),a("#portalLoginBtn").text("Log in"),k.portals.sourcePortal.withCredentials=!1)}),a("#destWebTierAuthChk").click(function(b){!0===a(b.currentTarget).prop("checked")?(a("#destinationUsername").attr("disabled",!0),a("#destinationPassword").attr("disabled",!0),a("#destinationLoginBtn").text("Proceed"),k.portals.destinationPortal.withCredentials=!0):(a("#destinationUsername").removeAttr("disabled"),a("#destinationPassword").removeAttr("disabled"),a("#destinationLoginBtn").text("Log in"),k.portals.destinationPortal.withCredentials=!1)}),a("[data-action='login-agol']").click(function(){g.getCredential(j.portalUrl,{oAuthPopupConfirmation:!1}).then(function(c){a("#splashContainer").css("display","none"),a("#itemsContainer").css("display","block"),k.portals.sourcePortal=new b.Portal({portalUrl:c.server+"/",username:c.userId,token:c.token}),q()})}),a("[data-action='logindestination']").click(function(){var c=g.toJson(),e=sessionStorage.esriJSAPIOAuth;sessionStorage.setItem("esriJSAPIOAuthBackup",e),sessionStorage.setItem("esriIdBackup",JSON.stringify(c)),g.destroyCredentials(),sessionStorage.removeItem("esriJSAPIOAuth"),g.getCredential(j.portalUrl,{oAuthPopupConfirmation:!1}).then(function(f){k.portals.destinationPortal&&k.portals.destinationPortal.portalUrl===j.portalUrl||(k.portals.destinationPortal=new b.Portal({portalUrl:f.server+"/",username:f.userId,token:f.token})),g.initialize(c),sessionStorage.setItem("esriJSAPIOAuth",e),k.portals.destinationPortal.self().then(function(){a("#copyModal").modal("hide"),I(),d.start(),P(),d.done()})})}),a("#portalLoginBtn").click(function(){r()}),a("[data-action='copyMyAccount']").click(function(){k.portals.destinationPortal=k.portals.sourcePortal,a("#copyModal").modal("hide"),I(),d.start(),P(),d.done()}),a("[data-action='copyOtherAccount']").click(function(){a("#destinationChoice").css("display","none"),a("#destinationForm").css("display","block")}),a("#destinationLoginBtn").click(function(){t()}),a("#destinationLoginBtn").click(function(){a("#destinationLoginBtn").button("reset")}),a("#destinationCancelBtn").click(function(){a("#actionDropdown li").removeClass("active")}),a("#destinationLoginForm").keypress(function(b){13==b.which&&a("#destinationLoginBtn").focus().click()}),a("#portalLoginForm").keypress(function(b){13==b.which&&a("#portalLoginBtn").focus().click()}),a(document).on("click","#searchMenu li",function(b){var c=a(b.target).parent().attr("data-action");"viewMyContent"!==c&&"viewMyGroups"!==c?(a("#searchMenu li").removeClass("active"),a(b.target).parent().addClass("active"),a("#searchText").val()?w():a("#searchText").attr("placeholder",a(b.currentTarget).text())):"viewMyGroups"==c?(d.start(),O(),d.done()):(d.start(),N(),d.done())}),a(document).on("click","#btnSimpleCopy",function(){a("#serviceNameForm").hide(),a(".alert-danger.alert-dismissable").remove(),a("#btnCopyService").removeClass("disabled"),a("#btnSimpleCopy").addClass("btn-primary active"),a("#btnFullCopy").removeClass("btn-primary active"),a("#btnFullCopy").addClass("btn-default")}),a(document).on("click","#btnFullCopy",function(){a("#serviceNameForm").show(),a("#btnCopyService").addClass("disabled"),a("#btnFullCopy").addClass("btn-primary active"),a("#btnSimpleCopy").removeClass("btn-primary active"),a("#btnSimpleCopy").addClass("btn-default"),a("#serviceName").blur()}),a(document).on("click","#btnCancelCopy",function(b){var c=a(b.currentTarget).attr("data-id");a(".clone[data-id='"+c+"']").remove(),a("#btnCancelCopy").attr("data-id",""),a("#serviceName").attr("value",""),a("#btnSimpleCopy").click(),a("#deepCopyModal").modal("hide")}),a(document).on("click","#btnCopyService",function(b){var c=a(b.currentTarget).attr("data-id"),d=a(".clone[data-id='"+c+"']").parent().attr("data-folder");switch(a("#copySelector > .btn-primary").text()){case"Simple":D(c,d);break;case"Full":E(c,d)}a("#btnCancelCopy").attr("data-id",""),a("#serviceName").attr("value",""),a("#btnSimpleCopy").click(),a("#deepCopyModal").modal("hide")}),a(document).on("click","li [data-action]",function(b){var c=a(b.target).parent().attr("data-action");switch("stats"!==c&&(a("#actionDropdown li").removeClass("active"),a(b.target).parent().addClass("active")),c){case"inspectContent":G(),x();break;case"updateWebmapServices":G(),y();break;case"updateContentUrl":G(),z();break;case"stats":A();break;case"logout":v()}}),a("#copyModal").on("show.bs.modal",function(){G(),a("#destinationChoice").css("display","block"),a("#destinationForm").css("display","none")}),a("#currentUrl").text(window.location.origin+window.location.pathname),a("[data-toggle='tab']").click(function(b){var c=a(b.target),d=c.attr("aria-controls");switch(d){case"userPassTab":case"oauthTab":case"pkiIwaTab":case"userPassTab2":case"oauthTab2":case"pkiIwaTab2":console.log(d)}})})});